# Sitecore Content SDK Next.js Sample Application

This app powers `https://nextjs.xmc-starter-js.localhost` in the local XM Cloud stack. It mounts into the `rendering-nextjs` container and can also be run directly with `npm run dev` for faster iteration.

## Prerequisites

- Node.js 18+ (same version configured in `local-containers/.env` as `NODEJS_VERSION`)
- Sitecore CM running locally via the Docker instructions in `../local-containers/README.md`

## Environment configuration

`/.env.local` and `/.env.container.example` are pre-populated with the values generated by `scripts/init.ps1`. Key settings:

| Variable | Source | Description |
| --- | --- | --- |
| `SITECORE_API_HOST` / `NEXT_PUBLIC_SITECORE_API_HOST` | `https://xmcloudcm.localhost` | Local CM hostname exposed by Traefik. |
| `NEXT_PUBLIC_SITECORE_API_KEY` | Value from `.env.local` (copied from `local-containers/.env:SITECORE_API_KEY_APP_STARTER`) | API key stored under `/sitecore/system/Settings/Services/API Keys/content-sdk-test`. |
| `SITECORE_EDITING_SECRET` | Value from `.env.local` (generated by `init.ps1`) | Shared between CM and this app for Experience Editor. |
| `NEXT_PUBLIC_DEFAULT_SITE_NAME` | `content-sdk-test` | Site to query in GraphQL. |

If you regenerate secrets (e.g., re-run `init.ps1`), update `.env.local` and restart the rendering container.

## Running locally (hot reload)

```powershell
cd headapps/content-sdk-ssr
npm install        # first time only
npm run dev        # serves https://localhost:3000 with live reload
```

The dev server reads `.env.local` and uses the same CM + API key as the Dockerized host. Stop it before restarting the Docker renderer to avoid port conflicts.

## Running inside Docker

The `rendering-nextjs` service in `local-containers/docker-compose.override.yml` mounts this folder (`../headapps/content-sdk-ssr:/app`) and runs `npm run start:connected` (which aliases to `npm run dev`). To restart it after code or env changes:

```powershell
cd local-containers
docker compose up -d rendering-nextjs
docker compose logs -f rendering-nextjs   # optional: watch rebuild output
```

## Editing code

- Components live in `src/components`.
- Styles live in `src/styles` / `src/assets`.
- GraphQL queries are generated into `src/lib/graphql/generated.ts` via `npm run sitecore-tools:generate-map`.

Every save triggers Next.js hot reload both locally and inside the Docker container because the source directory is bind-mounted.

## Useful commands

```bash
npm run lint           # ESLint checks (configured for TypeScript + Content SDK)
npm run build          # Production build (uses `.env.local` values)
npm run sitecore-tools:build   # Regenerates metadata, queries, templates
```

## Troubleshooting

- **“Provided SSC API keyData is not valid.”** – Run `./local-containers/docker/build/cm/templates/import-templates.ps1 -RenderingSiteName content-sdk-test -SitecoreApiKey <key>` and restart the renderer.
- **Experience Editor endpoints failing** – Confirm the `Rendering Hosts/Default` item points to `https://nextjs.xmc-starter-js.localhost` and that Traefik is running.
- **TLS errors in Node** – Ensure `NODE_EXTRA_CA_CERTS` points to the mkcert root installed during `scripts/init.ps1`.

For general SDK documentation see the [Sitecore Content SDK docs](https://doc.sitecore.com/xmc/en/developers/xm-cloud/sitecore-javascript-rendering-sdk--jss--for-next-js.html).
